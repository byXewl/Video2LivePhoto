workflows:
  unsigned-swift-build:
    name: Unsigned Swift Build
    environment:
      xcode: 15.4
    scripts:
      - name: Resolve SPM & Pods
        script: |
          # 如果用 CocoaPods
          [ -f Podfile ] && pod install --repo-update
          # 拉取 SPM 依赖
          xcodebuild -resolvePackageDependencies -project Video2LivePhoto.xcodeproj -scheme Video2LivePhoto
      - name: Build .app (Release, 无签名)
        script: |
          xcodebuild archive \
                -project Video2LivePhoto.xcodeproj \
                -scheme Video2LivePhoto \
                -configuration Release \
                -archivePath "$PWD/build/Video2LivePhoto.xcarchive" \
                CODE_SIGNING_ALLOWED=NO \
                CODE_SIGNING_REQUIRED=NO \
                CODE_SIGN_IDENTITY="" \
                PROVISIONING_PROFILE_SPECIFIER=""
      - name: Export .app 并打包
        script: |
          # Archive 产物路径
          APP_PATH="$(find "$PWD/build" -name 'Video2LivePhoto.app' -type d)"
          [ -z "$APP_PATH" ] && APP_PATH="$(find ~/Library/Developer/Xcode/DerivedData -name 'Video2LivePhoto.app' -type d | head -n1)"
          mkdir -p build/ios
          cp -R "$APP_PATH" build/ios/
          cd build/ios
          zip -r Video2LivePhoto.app.zip Video2LivePhoto.app
    artifacts:
      - build/ios/Video2LivePhoto.app.zip